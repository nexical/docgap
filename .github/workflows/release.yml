name: Release

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  dogfood:
    name: Pre-release Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install Dependencies
        run: npm install

      - name: Build Action
        run: npm --filter @docgap/action... build

      - name: Run Drift Check (Dogfood)
        run: node apps/action/dist/index.js
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
          INPUT_CONFIG: .docgap.yaml
          INPUT_STRICT: true

  npm-publish:
    name: Publish to NPM
    needs: dogfood
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: npm install

      - name: Build
        run: npm build

      # Only publish nicely if we are detecting a change, but since we are doing manual dispatch or push to main,
      # we can try to publish and fail gracefully if version exists, or check version.
      # For now, we will just attempt publish.
      - name: Publish CLI
        if: github.repository == 'nexical/docgap' # Replace with actual repo if known, good safety
        run: |
          cd apps/cli
          PACKAGE_NAME=$(node -p "require('./package.json').name")
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          
          # Check if version exists on NPM (suppress output, just check exit code)
          if npm view "$PACKAGE_NAME@$PACKAGE_VERSION" > /dev/null 2>&1; then
            echo "Version $PACKAGE_VERSION of $PACKAGE_NAME already exists on NPM. Skipping publish."
          else
            echo "Publishing $PACKAGE_NAME@$PACKAGE_VERSION..."
            npm publish --access public
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  action-release:
    name: Release GitHub Action
    needs: dogfood
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: npm install

      - name: Build Action
        run: npm --filter @docgap/action... build

      - name: Commit and Push dist
        # We only want to commit the compiled dist for the action
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Force add the apps/action/dist folder
          git add -f apps/action/dist
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(action): update bundled action [skip ci]"
            # Push to a separate branch or update the v1 tag.
            # Updating a major version tag like v1 is common for actions.
            
            git tag -fa v1 -m "Update v1 tag"
            git push origin v1 --force
          fi
